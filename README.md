# NexignTask-2025

## Оглавление
1. [Задача](#задача)
2. [Описание решения](#описание-решения)
   - [Основные функции](#основные-функции)
   - [REST Endpoints](#rest-endpoints)
3. [Библиотеки](#библиотеки)
4. [Покрытие тестами](#покрытие-тестами)
5. [Запуск проекта](#запуск-проекта)
6. [Список номеров абонентов](#список-номеров-абонентов) 

---

## Задача

Все звонки, совершенные абонентом сотового оператора, собираются на коммутаторах и фиксируются в CDR формате. Когда абонент находится в роуминге, за процесс сбора его данных отвечает обслуживающая сеть абонента. Для стандартизации данных между разными операторами, международная ассоциация GSMA ввела стандарт BCE. Согласно ему, данные с CDR должны агрегироваться в единый отчет UDR, который впоследствии передается оператору, обслуживающему абонента в домашней сети. На основе этого отчета, домашний оператор выставляет абоненту счет.

Цель задания – смоделировать описанный процесс в упрощенном виде.

Целевой микросервис будет:
- Генерировать CDR записи.
- Сохранять их в базу данных.
- Предоставлять REST API для получения UDR отчетов и генерации сводного отчета с CDR записями по абоненту.

### CDR-запись включает в себя следующие данные:
- Тип вызова (`01` - исходящие, `02` - входящие).
- Номер абонента, инициирующего звонок.
- Номер абонента, принимающего звонок.
- Дата и время начала звонка (ISO 8601).
- Дата и время окончания звонка (ISO 8601).

### CDR-отчет представляет из себя набор CDR-записей:
- Разделитель данных – запятая.
- Разделитель записей – перенос строки.
- Данные обязательно формируются в хронологическом порядке.
- В рамках задания CDR-отчет может быть обычным `.txt` или `.csv`.

### UDR представляет из себя объект в формате JSON, который включает в себя:
- Номер абонента.
- Сумму длительности его звонков.

### Необходимо:
1. Написать часть, эмулирующую работу коммутатора, т.е. генерирующую CDR записи.
2. Написать часть, предоставляющую REST API для работы с UDR.
3. Написать часть, формирующую и сохраняющую CDR-отчет.

---

## Описание решения

### Основные функции:
- Генерация CDR записей для абонентов.
- Сохранение CDR записей в базу данных.
- Предоставление REST API для получения UDR отчетов.

---

### REST Endpoints

#### 1. Получение UDR отчета для одного абонента
- **Метод**: `GET`
- **URL**: `/udr/{msisdn}`
- **Параметры**:
  - `msisdn` (строка): Номер абонента.
  - `month` (опционально, строка): Месяц в формате `YYYY-MM`.

**Пример запроса №1**:
```
http://localhost:8080/udr/79992221122
```

**Ответ**:
```json
{
  "msisdn": "79992221122",
  "incomingCall": {
    "totalTime": "179:12:44"
  },
  "outcomingCall": {
    "totalTime": "187:01:02"
  }
}
```

**Пример запроса №2**:
```
http://localhost:8080/udr/79992221122?month=2025-02
```

**Ответ**:
```json
{
  "msisdn": "79992221122",
  "incomingCall": {
    "totalTime": "15:27:44"
  },
  "outcomingCall": {
    "totalTime": "13:33:42"
  }
}
```

---

#### 2. Получение UDR отчетов для всех абонентов за месяц
- **Метод**: `GET`
- **URL**: `/udr/monthly`
- **Параметры**:
  - `month` (строка): Месяц в формате `YYYY-MM`.

**Пример запроса**:
```
http://localhost:8080/udr/monthly?month=2025-02
```

**Ответ**:
```json
{
  "79992221122": {
    "msisdn": "79992221122",
    "incomingCall": {
      "totalTime": "02:12:13"
    },
    "outcomingCall": {
      "totalTime": "00:02:50"
    }
  },
  "79993331133": {
    "msisdn": "79993331133",
    "incomingCall": {
      "totalTime": "01:30:00"
    },
    "outcomingCall": {
      "totalTime": "00:45:00"
    }
  }
}
```

---

#### 3. Генерация CDR отчета
- **Метод**: `POST`
- **URL**: `/report/generate`
- **Параметры**:
  - `msisdn` (строка): Номер абонента.
  - `startDate` (дата и время): Начало периода.
  - `endDate` (дата и время): Конец периода.

**Пример запроса**:
```
http://localhost:8080/report/generate?msisdn=79992221122&startDate=2025-02-01T00:00:00&endDate=2025-02-28T23:59:59
```

**Ответ**:
```
Request ID: 6904e40f-43cb-4947-acc1-d1fbcea2f724
```

**Пример запроса с ошибкой**:
```
http://localhost:8080/report/generate?msisdn=79992221122&startDate=2023-02-01T00:00:00&endDate=2023-02-28T23:59:59
```

**Ответ**:
```
Error: No CDR records found
```

---

## Библиотеки

1. **Spring Boot**: Упрощает разработку и настройку приложения.
2. **Spring Data JPA**: Упрощает взаимодействие с базой данных, предоставляет готовые методы для CRUD-операций и кастомных запросов.
3. **H2 Database**: Используется для тестирования и локальной разработки, не требует установки внешней СУБД.
4. **Lombok**: Уменьшает объем кода, делает его более читаемым и поддерживаемым.
5. **JUnit 5**: Необходим для написания тестов.
6. **Mockito**: Позволяет изолировать тестируемый код от зависимостей, упрощает тестирование.
7. **Spring Boot Starter Web**: Предоставляет инструменты для создания REST API и обработки HTTP-запросов.
8. **JaCoCo**: Используется для анализа покрытия кода тестами.

---

## Покрытие тестами

<img width="594" alt="Снимок экрана 2025-03-23 в 14 23 55" src="https://github.com/user-attachments/assets/fe543d16-67ea-4b4f-8c88-ea1a0d0749be" />

Отчёт по покрытию тестами находится в директории:  
`target/site/jacoco/index.html`

Генерация отчёта производится командой:  
```
mvn test jacoco:report
```

---

## Запуск проекта

Jar файл находится в директории:  
`target/application-0.0.1.jar`

Запуск проекта производится командой:  
```
java -jar {путь до файла}/application-0.0.1.jar
```

Обращение к эндпоинтам производится через
```
http://localhost:8080/
```

---

## Список номеров абонентов

- 79992221122
- 79993331133
- 79994441144
- 79995551155
- 79996661166
- 79997771177
- 79998881188
- 79999991199
- 79991112233
- 79992223344
